{% extends "targetadmin/base.html" %}
{% block extrahead %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/admin.css">
{% endblock %}
{% block title %}Campaign Setup Wizard{% endblock %}
{% block content %}
    <h2 class="page-header">Create a New Targeted Sharing Campaign</h2>
    <form id="wizard-form" action="" method="post" class="form-horizontal">
        {% csrf_token %}
        <span id="campaign-settings" class="wizard-step">
            {% include 'targetadmin/includes/campaign_wizard_form.html' %}
        </span>
        <span id="filtering" class="wizard-step" style="display: none;">
            {% include 'targetadmin/includes/filter_wizard_form.html' %}
        </span>
        <span id="fbobjects" class="wizard-step" style="display: none;">
            {% include 'targetadmin/includes/fbobjects_wizard_form.html' %}
            <input type="submit" class="btn btn-large btn-primary step-submit fbobject-step" value="Submit" id="wizard-submit">
            <a href="#" id="step3-prev" class="btn btn-large btn-danger step-submit" data-step="filtering">Previous</a>
        </span>
    </form>
{% endblock %} {% block extrascript %}
<script>
    
    var layer_count = 1,
        can_close_modal = true;

    var sizeImgHelper = function() {
        var window_height = $(window).height(),
            img_helper_wrapper = $('.img-helper-wrapper:visible');

        if( img_helper_wrapper ) {
            img_helper_wrapper.height( window_height - img_helper_wrapper.offset().top - 30 );
        }
    }

    //TODO: add debouncer
    $(window).resize(sizeImgHelper);
    $( sizeImgHelper );

    $('i.icon-question-sign').popover( { trigger: 'hover' } );
    
    $('div[data-helper="img"] input').on( 'focus', function() {
        $('#' + $(this).attr('name') + '-img-helper' ).fadeIn( 400 );
    } );
    
    $('div[data-helper="img"] input').on( 'blur', function() {
        $('#' + $(this).attr('name') + '-img-helper' ).hide();
    } );

    // Tracks number of layers in play on Filtering screen

    // "Steps"
    $('.step-submit').click(function(e) {
        var step = $(this).data('step');
        if ($(this).hasClass('filter-step')) {
            var v, values, filters, layer;
            for (layer = 1; layer <= layer_count; layer++) {
                filters = $('#enabled-filters-' + layer).sortable('toArray', 
                    {attribute: 'data-filter-id'});
                values = [];
                for (v = 0; v < filters.length; v++) {
                    values.push('"' + filters[v].split('=')[1] + '"');
                }
                $('#id_enabled-filters-' + layer).val(values);
            }
        }
        $('.wizard-step').hide();
        $('#' + step).show();

        if( step === 'fbobjects' ) {
            sizeImgHelper();
            window.fbObjIndicator.handleWindowResize();
        }
    });

    // Remove Layer "X" clicked
    $('#filtering').on( 'click', '.remove-layer', function() {

        var deleted_layer_no = $(this).data('layer'),
            add_layer_btn = $('#add-layer');

        $.each( $('section[data-layer]'), function( i, layer_section ) {
            var $layer_section = $( layer_section );
            if( $layer_section.data('layer') == deleted_layer_no ) {

                $.each( $layer_section.find('div[data-filter-id]'), function( j, layer_filter ) {
                    var $layer_filter = $(layer_filter),
                        layer_filter_id = $layer_filter.data('filter-id');
                        
                    if( ( $('#existing-filters').find( 'div[data-filter-id="' + layer_filter_id + '"]' ).length === 0 ) &&
                        ( $('#enabled-filters-1').find( 'div[data-filter-id="' + layer_filter_id + '"]' ).length === 0 ) ) {

                        $('#existing-filters').append( $layer_filter );
                    }
                    
                } );

                $layer_section.fadeOut( 400, function() {
                    $(this).empty().remove();

                    $.each( $('*[data-layer]'), function( k, el ) {
                        var $el = $(el),
                            el_layer_no = $el.data('layer'),
                            new_layer_no = el_layer_no - 1;

                        if( el_layer_no > deleted_layer_no ) {
                            
                            $el.data( 'layer', new_layer_no );

                            if( $el.prop('tagName') === 'SECTION' ) {

                                $el.find('h5').first().text( 'Layer ' + new_layer_no );

                                $('#id_enabled-filters-' + el_layer_no )
                                    .attr( { "id": 'id_enabled-filters-' + new_layer_no,
                                             "name": 'enabled-filters-' + new_layer_no } );
                                           
                                $('#enabled-filters-' + el_layer_no )
                                    .attr( { "id": 'enabled-filters-' + new_layer_no } );
                            }
                        }
                    } );
                } );
            }
        } );

        layer_count--;
        add_layer_btn.data( 'layer-count', layer_count );

        if( add_layer_btn.prop( 'disabled' ) ) {
            add_layer_btn.prop( 'disabled', false );
        }
        
    } );

    // Sortables - Drag and Drop stuff
    $(function() {
        $('#existing-filters').sortable({
            connectWith: ".target-well"
        });
        $('#enabled-filters-1').sortable({
            connectWith: ".target-well"
        });
        $( ".sortable" ).disableSelection();
    });

    // Layer addition
    $('#add-layer').click(function(event){
        event.preventDefault();
        var previous_layer_html = $('#enabled-filters-' + layer_count).html()
        var hidden_elements = $('.hidden-elements')
        layer_count = $('#add-layer').data('layer-count') + 1;
        $('#add-layer').data('layer-count', layer_count);
        $('#enabled-section').append(
            '<section data-layer="' + layer_count + '">' +
            '<div class="clearfix"><h5 class="layer-text-header pull-left">Layer ' + layer_count + '</h5>' +
            '<h5 data-layer="' + layer_count + '" class="btn btn-link pull-right remove-layer">' +
            '<i class="icon-remove"></i></h5></div><div class="clearfix"><input type="hidden" id="id_enabled-filters-' + 
            layer_count + '" name="enabled-filters-' + layer_count + 
            '"><div style="margin-left: 0px; min-height:54px;" class="span12 well sortable target-well" id="enabled-filters-' + 
            layer_count + '">' + previous_layer_html  + '</div></div></section>'
        );

        $('#enabled-filters-' + layer_count).sortable({
            connectWith: '.target-well'
        });
        // Aribtrary limit, but seems about right. Subject to change
        if (layer_count >= 4) {
            $('#add-layer').prop('disabled', true);
        }
    });

    // New FilterFeature creation
    $('#filter-add').click(function(event) {
        event.preventDefault()
        var filter_values = '';
        $('.filter-val-input').each(function(index){
            var value = $(this).val();
            if (value) {
                if (filter_values === ''){
                    filter_values = value;
                } else {
                    filter_values += '||' + value;
                }
            }
        });
        if (filter_values.slice(-2) === '||'){
            filter_values = filter_values.substr(0, filter_values.length - 2);
        }
        $('#id_value').val(filter_values);
        var validation_elems = [
            [$('#id_feature'), $('#feature-error')],
            [$('#id_operator'), $('#operator-error')],
            [$('#id_value'), $('#value-error')]
        ]
        var form_errors = false;
        for (var elem=0; elem < validation_elems.length; elem++) {
            if (validation_elems[elem][0].val() === ""){
                validation_elems[elem][1].show();
                form_errors = true;
            } else {
                validation_elems[elem][1].hide();
            }
        }
        if (!form_errors) {
            var feature = $('#id_feature').val();
            var operator = $('#id_operator').val();
            var filter_values = $('#id_value').val();
            $('#existing-filters').prepend(
                '<div data-filter-id="set_number=' + feature + '.' + operator + 
                '.' + filter_values + '" class="span2 draggable"><p><abbr title="' + 
                feature + ' ' + operator + ' ' + filter_values + '">' + 
                feature + ' ' + ' ' + operator + ' ' + filter_values.slice(0, 15) + 
                '</abbr></p></div>'
            );

            if( can_close_modal ) {
                $('#filter-modal').modal('toggle');
                $('#filter-modal').removeData();
            }
        }
    });

    
</script>
{% endblock %}
