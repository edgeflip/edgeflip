{% extends "targetadmin/base.html" %}
{% block title %}Filter Testing{% endblock %}
{% block extrahead %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/admin.css">
{% endblock %}
{% block content %}
<div class="row">
    <div class="span12">
        <div class="row" id="enabled-section">
            <h2>Targeting Criteria</h2>
            <p>
                The below items will be chained together with ANDs. 
                We highly recommend adding extra, subsequent targeting layers 
                as "fallbacks". For example, you may have a targeting criteria 
                of 18-34, Female, and living in Illinois. If a person using 
                the sharing platform doesn't have an adequate number of 
                friends meeting those requirements they won't be served any 
                friends to share with. 
            </p>
            <p>
                As a result, a fallback criteria might 
                be: Women that are 18-34. If that falls to find enough 
                friends, a further fullback of simply: Women, might be 
                applicable. As always, feel free to contact us for assistance
            </p>
            <h3>Enabled Filters <button id="add-layer" class="btn btn-mini" data-layer-count="1">Add Layer</button></h3>
            <h5>Top Layer</h5>
            <div class="row">
                <div class="span12 well sortable target-well" id="enabled-filters-1"></div>
            </div>
        </div>
        <div class="row">
            <h3>Available Filters <button data-target="#filter-modal" href="{% url 'filter-add' client.pk %}" role="button" class="btn btn-mini" data-toggle="modal">Create Filter</button></h3>
            <div class="span12 well sortable target-well" id="existing-filters" style="margin-left: 0px;">
                {% for ff in filter_features %}
                <div id="set_number={{ ff.pk }}" class="span2 draggable"><p><abbr title="{{ ff.pretty_name }}">{{ ff.pretty_name|truncatechars:30 }}</abbr></p></div>
                    {% if forloop.counter > 10 %}
                        <br />
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<div id="filter-modal" class="modal hide fade" tabindex="-1" role="dialog" data-remote="{% url 'filter-add' client.pk %}">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="filter-modal-label">Create Filter</h3>
    </div>
    <div class="modal-body">
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button id="submit-filter-add" class="btn btn-primary">Save changes</button>
    </div>
</div>
{% endblock %}
{% block extrascript %}
<script>
    $(function() {
        $('#existing-filters').sortable({
            connectWith: ".target-well"
        });
        $('#enabled-filters-1').sortable({
            connectWith: ".target-well"
        });
        $( ".sortable" ).disableSelection();
        $('.sortable').on("sortupdate", function(event, ui) {
            console.log(event);
            console.log(ui);
        });
    });
</script>
<script>
    var layer_count = 1;
    $('#add-layer').click(function(e){
        layer_count = $('#add-layer').data('layer-count') + 1;
        $('#add-layer').data('layer-count', layer_count);
        $('#enabled-section').append(
            '<h5>Layer ' + layer_count + '</h5><div class="row"><div class="span12 well sortable target-well" id="enabled-filters-' + layer_count + '"></div></div>'
        );
        $('#enabled-filters-' + layer_count).sortable({
            connectWith: '.target-well'
        });
        if (layer_count >= 5) {
            $('#add-layer').prop('disabled', true);
        }
    });
</script>
<script>
    $('#submit-filter-add').click(function(event) {
        $.ajax({
            type: "POST",
            url: "{% url 'filter-add' client.pk %}",
            data: $('#add-filter-form').serialize()
        }).done(function(data){
            $('#existing-filters').prepend(data.html);
            $('#filter-modal').modal('toggle');
        });
    });
</script>
{% endblock %}
