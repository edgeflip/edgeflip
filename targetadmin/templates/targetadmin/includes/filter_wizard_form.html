<div class="row">
    <div class="span12">
        <div class="row targeting-header">
            <div class="span12 header-container">
                <h2 class="wizard-header">Select a target audience</h2>
                <p>
                    Define a Target Audience for your campaign by dragging one or more filters from the Available Filters container to the Enabled Filters container.
                </p>
                <p>
                    To create a new filter, just click "Add Filter," select the filter type and filtering criteria, and click "Save changes."
                </p>
                <p>
                    <span>You can also add up to four Fallback Audiences with fewer filters enabled.</span>
                    <button id="learn-more-btn" type="button" class="btn btn-link">Learn more</button>
                </p>
            </div>
            
        </div>

        <div id="enabled-section" class="row">
            <h3 class="span12">Enabled Filters</h3>
            <h6 class="span12">
                <span>Target Audience</span>
                <button type="button" id="add-layer" class="btn btn-mini add-fallback-btn" data-layer-count="1">Add Fallback Audience</button>
            </h6>
            <div class="span12">
                <input type="hidden" id="id_enabled-filters-1" name="enabled-filters-1">
                <div class="clearfix well sortable target-well filter-well" id="enabled-filters-1"></div>
            </div>
        </div>
        <div id="available-section" class="row">
            <h3 class="span12">
                <span>Available Filters</span>
                <button type="button"
                        data-target="#filter-modal"
                        href="{% url 'targetadmin:filter-add' client.pk %}"
                        id="create-filter-btn"
                        class="btn btn-mini add-filter-btn"
                        data-toggle="modal">Add Filter</button>
            </h3>
            <div class="span12 well sortable target-well filter-well" id="existing-filters"></div>
        </div>
        <div class="row empty-fallback">
            <div class="span12">
                {{ campaign_form.include_empty_fallback.errors }}
                <label for="{{ campaign_form.include_empty_fallback.id_for_label }}">{{ campaign_form.include_empty_fallback.label }}:</label>
                {{ campaign_form.include_empty_fallback }}
                <i id="empty-fallack-help-icon" class="icon-question-sign empty-fallback-question" data-placement="right" data-content=""></i>
            </div>
        </div>
       
        <div class="row wizard-button-container">
            <button type="button" id="step2-prev" class="btn btn-link step-submit filter-step pull-left" data-step="intro">Previous</button>
            <button type="button" id="step2-next" class="btn btn-large btn-primary step-submit filter-step" data-step="faces">Next</button>
        </div>
    </div>
</div>
<div id="filter-modal" class="modal hide fade" tabindex="-1" role="dialog">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="filter-modal-label">Create Filter</h3>
    </div>
    <div class="modal-body">
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
        <button id="filter-add" class="btn btn-primary">Save changes</button>
    </div>
</div>
<div id="target-audience-help-modal" class="modal hide fade" tabindex="-1" role="dialog">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="filter-modal-label">Targeted Sharing Audience</h3>
    </div>
    <div class="modal-body filter-help">
        <p>
            <i class="begin">Target Audience : </i> When your supporters share your campaign with their Facebook friends, we will present
            them with a list of friend suggestions based on the target audience you define using a set of filters. You can
            enable multiple filters; your target audience will consist of friends who meet all of these criteria.
            For example, if your target audience is <i>24 - 30 year-old men living in North Carolina</i>, then you would
            enable three filters -- 'Males', 'Between 24 and 30', and 'Lives in North Carolina.'
        </p>
        <p>
            <i class="begin">Fallback Audiences : </i> Some of your supporters may not have any friends in your Target Audience.
            For this reason, we recommend adding one or more Fallback Audiences with fewer (or less restrictive)
            filters enabled. For example, if your Target Audience is <i>24 - 30 year-old men living in North Carolina</i>,
            your first Fallback Audience might expand the age filter: <i>18 - 50 year-old men living in North Carolina</i>.
            You might also select a second Fallback Audience with an expanded location filter: <i>24 - 30 year-old men
            living in North Carolina, South Carolina, and Virginia</i>. A third Fallback Audience might simply target <i>men</i>.
            To add a Fallback Audience, just click "Add Fallback Audience." 
        </p>
        <p id="empty-fallback-paragraph">
            <i class="begin">Empty Fallback : </i> 
        </p>
        <p>
            <i class="begin">More questions?</i> Please <a href="mailto:help@edgeflip.com" target="_blank">contact us</a> and we'll be happy to walk you through it.
        </p>
    </div>
</div>
<script src="{{ STATIC_URL }}js/models/filterModels.js"></script>
<script src="{{ STATIC_URL }}templates/filter.js"></script>
<script type="text/javascript">

var layer_count = 1;

( function( $ ) {

    // Remove Layer "X" clicked
    $('#filtering').on( 'click', '.remove-layer', function() {

        var deleted_layer_no = $(this).data('layer'),
            add_layer_btn = $('#add-layer');

        $.each( $('section[data-layer]'), function( i, layer_section ) {
            var $layer_section = $( layer_section );
            if( $layer_section.data('layer') == deleted_layer_no ) {

                $.each( $layer_section.find('div[data-filter-id]'), function( j, layer_filter ) {
                    var $layer_filter = $(layer_filter),
                        layer_filter_id = $layer_filter.data('filter-id');
                        
                    if( ( $('#existing-filters').find( 'div[data-filter-id="' + layer_filter_id + '"]' ).length === 0 ) &&
                        ( $('#enabled-filters-1').find( 'div[data-filter-id="' + layer_filter_id + '"]' ).length === 0 ) ) {

                        $('#existing-filters').append( $layer_filter );
                    }
                    
                } );

                $layer_section.fadeOut( 400, function() {
                    var found = false;
     
                    if( $(this).find('#add-layer').length ) { 
                        $('#add-layer').hide().appendTo($('body'));
                        found = true;
                    }

                    $(this).empty().remove();

                    if( found ) {
                        if( $('#enabled-section').children('section').length ) {
                            $('#enabled-section').children('section').last().find('h6').first().append( $('#add-layer').show() );
                        } else {
                            $('#enabled-section').children('h6').first().append( $('#add-layer').show() );
                        }
                    }

                    $.each( $('*[data-layer]'), function( k, el ) {
                        var $el = $(el),
                            el_layer_no = $el.data('layer'),
                            new_layer_no = el_layer_no - 1;

                        if( el_layer_no > deleted_layer_no ) {
                            
                            $el.data( 'layer', new_layer_no );

                            if( $el.prop('tagName') === 'SECTION' ) {

                                $el.find('h6 span').first().text( 'Fallback Audience ' + ( new_layer_no - 1 ) );

                                $('#id_enabled-filters-' + el_layer_no )
                                    .attr( { "id": 'id_enabled-filters-' + new_layer_no,
                                             "name": 'enabled-filters-' + new_layer_no } );
                                           
                                $('#enabled-filters-' + el_layer_no )
                                    .attr( { "id": 'enabled-filters-' + new_layer_no } );
                            }
                        }
                    } );
                } );
            }
        } );

        layer_count--;
        add_layer_btn.data( 'layer-count', layer_count );

        if( add_layer_btn.prop( 'disabled' ) ) {
            add_layer_btn.prop( 'disabled', false );
        }
        
    } );

    filterReceived = function( event, ui ) {
        var dataLink = ui.item.attr('data-link');
        if( dataLink ) {
            ui.sender.find('[data-link="' + dataLink + '"]').appendTo( $(event.target) );
        }
    }
    
    // Sortables - Drag and Drop stuff
    $(function() {
        $('#existing-filters').sortable({
            connectWith: ".target-well",
            receive: filterReceived
        });
        $('#enabled-filters-1').sortable({
            connectWith: ".target-well",
            receive: filterReceived
        });
        $( ".sortable" ).disableSelection();
    });

    $('#filtering').on( 'dblclick', '.draggable', function() {
        var clickedEl = $(this),
            dataLink = clickedEl.attr('data-link'),
            lastEnabled = $('#enabled-section').find('.target-well').last(),
            availableFilters = $('#existing-filters');

        if( clickedEl.parent().attr('id') === 'existing-filters' ) {
            if( dataLink ) {
                clickedEl.siblings('[data-link="' + dataLink + '"]').appendTo( lastEnabled );
            }
            lastEnabled.append( clickedEl );
        } else {
            if( dataLink ) {
                clickedEl.siblings('[data-link="' + dataLink + '"]').appendTo( availableFilters );
            }
            clickedEl.appendTo( availableFilters );
        }
    } );

    // Layer addition
    $('#add-layer').click(function(event){
        event.preventDefault();
        var previous_layer_html = $('#enabled-filters-' + layer_count).html()
        var hidden_elements = $('.hidden-elements')
        layer_count = $('#add-layer').data('layer-count') + 1;
        $('#add-layer').data('layer-count', layer_count);
        $('#enabled-section').append(
            '<section class="span12" data-layer="' + layer_count + '">' +
            '<div class="row"><div class="span11"><h6 class="layer-text-header pull-left"><span>Fallback Audience ' + (layer_count - 1) + '</span></h6></div>' +
            '<div class="span1"><h6 data-layer="' + layer_count + '" class="btn btn-link pull-right remove-layer">' +
            '<i class="icon-remove"></i></h6></div></div><input type="hidden" id="id_enabled-filters-' + 
            layer_count + '" name="enabled-filters-' + layer_count + 
            '"><div class="clearfix well sortable target-well filter-well" id="enabled-filters-' + 
            layer_count + '">' + previous_layer_html  + '</div></section>'
        );

        $('#enabled-section').children('section').last().find('h6').first().append( $('#add-layer') );

        $('#enabled-filters-' + layer_count).sortable({
            connectWith: '.target-well',
            receive: filterReceived
        });
        // Aribtrary limit, but seems about right. Subject to change
        if (layer_count >= 4) {
            $('#add-layer').prop('disabled', true);
        }
    });

    var emptyFallbackHelpText = "We recommend selecting the 'empty fallback' feature in case some of your supporters have few friends in your Target and Fallback Audiences. When the empty fallback feature is selected, the Targeted Sharing application will still suggest the friends most likely to support your organization, even though no filters are enabled. The 'empty fallback' feature is selected by default for new campaigns.";

    $('#learn-more-btn').click( function() {
        $('#target-audience-help-modal').modal();
    } );

    $('#empty-fallback-paragraph').append( emptyFallbackHelpText );

    $('#empty-fallack-help-icon').data( 'content', emptyFallbackHelpText );

    var existingFilters =
        new filterCollection( {{ filter_features|safe }} ).forEach( function(model) {
            $('#existing-filters').append(
                Handlebars.templates.filter( _.extend( {}, model.attributes, { readable: model.getReadable() } ) )
             );
        } );

    var campaignFilters = _.map( {{ campaign_filters|safe }}, function( filter ) {
       return new filterCollection( filter ); 
    } );

    _.each( campaignFilters, function( layer, i ) {
        layer.forEach( function( model ) {
            var selector = 'div[data-filter-id="set_number=' + model.get('feature') + '.' + model.get('operator') + '.' + model.get('value') + '"]',
                fromAvailable = $('#existing-filters').find( selector );

            if( fromAvailable.length ) { fromAvailable.dblclick(); }
            else {
                $('#enabled-section').find( selector ).clone(true).first().appendTo('#existing-filters').dblclick();
            }
        } );
        if( campaignFilters.length - 1 != i &&
            campaignFilters[i+1].length != 0 ) {
            $('#add-layer').click();
            $('#enabled-section').children('section').last().find('.clearfix').empty();
        }
    } );

    //still need this for filter creation, will hopefully get rid of soon
    window.filterCleaner = {
    
        clean: {

            gender: function( filter ) {
                if( filter.data('filter-id').indexOf('Male') > -1 ) {
                    filter.attr( 'title', 'Males' )
                          .find('span').text('Males');
                } else {
                    filter.attr( 'title', 'Females' )
                          .find('span').text('Females');
                }
            },

            age: function( filter ) {
                var span = filter.find('span'),
                    title = filter.attr('title'),
                    regExp = /(\d+)/,
                    match = regExp.exec(title),
                    age = match[1];
                 
                if( filter.attr( 'title' ).indexOf('max') > -1 ) {
                    filter.attr( 'title', 'age: ' + age + ' and younger' );
                    span.text( 'age: ' + age + ' and younger' );
                } else {
                    filter.attr( 'title', 'age: ' + age + ' and older' );
                    span.text( 'age: ' + age + ' and older' );
                }
            },

            location: function( filter ) {
                var span = filter.find('span'),
                    title = filter.attr('title');

                filter.attr( 'title',
                    title.replace(/eq/,'in')
                         .replace(/state|city/i,'Lives')
                         .replace(/\|\|/g,' or ') );

                span.text(
                    span.text().replace(/eq/,'in')
                               .replace(/state|city/i,'Lives')
                               .replace(/\|\|/g,' or ')
                               .replace(/\|/g,'') );
            }

        },

        cleanFilter: function( filter ) {
            
            var filter = $(filter);

            window.filterCleaner.clean[ ( filter.data('filter-id').indexOf('gender') > -1 )
                ? 'gender'
                : ( filter.data('filter-id').indexOf('age') > -1 )
                    ? 'age'
                    : 'location' ]( filter );

            return filter;
        }
    };


    _.each( $('#existing-filters').children(), window.filterCleaner.cleanFilter );
        
} )(jQuery);
</script>
