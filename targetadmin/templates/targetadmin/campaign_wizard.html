{% extends "targetadmin/base.html" %}

{% block extrahead %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/admin.css">
    <link href="{{ STATIC_URL }}css/imageCompanion.css" rel="stylesheet">
{% endblock %}

{% block title %}Campaign Setup Wizard{% endblock %}


{% block content %}
    <h2 id="intro-header" class="wizard-header">Create a Targeted Sharing Campaign</h2>
    <div class="campaign-name hide">
        <span></span>
    </div>
    <div class="invalid-input-popover"></div>
    <form id="wizard-form" action="" method="post" class="form-horizontal">
        {% csrf_token %}
        <div id="intro" class="wizard-step">
            <div class="page-header-information row">
                <div class="span8 offset2">
                    <span>A targeted sharing campaign turns your supporters into influencers by asking them to share your content with friends who are likely to support your organization.</span>
                    <a href="{% url 'targetadmin:how-it-works' %}" target="_blank">Learn more about Targeted Sharing.</a>
                </div>
            </div>
            <div style="text-align:center;">
                <button type="button" class="get-started-btn btn btn-primary">Get Started</button>
            </div>
            <div class="row">
                <div id="intro-carousel" class="offset2 span8 carousel slide">
                    <ol class="carousel-indicators">
                        <li data-target="#intro-carousel" data-slide-to="0" class="active"></li>
                        <li data-target="#intro-carousel" data-slide-to="1"></li>
                        <li data-target="#intro-carousel" data-slide-to="2"></li>
                    </ol>
                    <div class="carousel-inner">
                        <div class="active item">
                            <img src="{{ STATIC_URL }}img/carousel-filter.jpg">
                            <div class="carousel-caption">
                                <h4>Audience Targeting</h4>
                                <p>
                                    First, you'll select the audience for your campaign by choosing a set of filters.
                                </p>
                            </div>
                        </div>
                        <div class="item">
                            <img src="{{ STATIC_URL }}img/carousel-faces.jpg">
                            <div class="carousel-caption">
                                <h4>Engage your supporters' social network</h4>
                                <p>
                                    Then, you'll configure the "Friend Suggestion Page" your supporters will use to share your campaign with their friends.
                                </p>
                            </div>
                        </div>
                        <div class="item">
                            <img src="{{ STATIC_URL }}img/carousel-fb-obj.jpg">
                            <div class="carousel-caption">
                                <h4>Facebook Post</h4>
                                <p>
                                    Finally, you'll create the Facebook post that your target audience will see. Clicking on this post will send users to your campaign content.
                                </p>
                            </div>
                        </div>
                    </div>
                    <a class="carousel-control left" href="#intro-carousel" data-slide="prev">&lsaquo;</a>
                    <a class="carousel-control right" href="#intro-carousel" data-slide="next">&rsaquo;</a>
                </div>
            </div>
        </div>
        <div id="filtering" class="wizard-step" style="display: none;">
            {% include 'targetadmin/includes/filter_wizard_form.html' %}
        </div>
        <div id="faces" class="wizard-step" style="display: none;">
            {% include 'targetadmin/includes/faces_wizard_form.html' %}
        </div>
        <div id="fbobjects" class="wizard-step" style="display: none;">
            {% include 'targetadmin/includes/fbobjects_wizard_form.html' %}
        </div>
        <div id="campaign-name-modal" class="modal hide fade" tabindex="-1" role="dialog">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h3 id="filter-modal-label">Name your campaign</h3>
            </div>
            <div class="modal-body">
                <div class="name-input-container">{{ campaign_form.name }}</div>
            </div>
            <div class="modal-footer">
                <a href="#" id="step1-next" class="btn btn-primary step-submit campaign-step" data-step="filtering">Continue</a>
            </div>
        </div>
    </form>
</div>
{% endblock %} {% block extrascript %}
<script src="{{ STATIC_URL }}js/usStates.js" async></script>
<script src="{{ STATIC_URL }}js/inputValidator.js"></script>
<script src="{{ STATIC_URL }}js/imageCompanion.js"></script>

<script>

$( function() {
    var myWindow = $(window),
        carouselEl = $('#intro-carousel'),
        setCarouselHeight = function() {
            carouselEl.height(
                myWindow.height() - carouselEl.offset().top - 10 );
        };

    setCarouselHeight();
    $(window).on( 'resize', setCarouselHeight )

    $('i.icon-question-sign').popover( { trigger: 'hover' } );
    
    // Tracks number of layers in play on Filtering screen

    // "Steps"
    $('.step-submit').click(function(e) {
        var step = $(this).data('step');
        if ($(this).hasClass('filter-step')) {
            var v, values, filters, layer;
            for (layer = 1; layer <= layer_count; layer++) {
                filters = $('#enabled-filters-' + layer).sortable('toArray', 
                    {attribute: 'data-filter-id'});
                values = [];
                for (v = 0; v < filters.length; v++) {
                    if( filters[v] ) {
                        values.push('"' + filters[v].split('=')[1] + '"');
                    }
                }
                $('#id_enabled-filters-' + layer).val(values);
            }
        }
        $('.wizard-step').hide();
        $('#' + step).show();
        
        if( step === 'faces' && (! window.facesImageCompanion.model.get('hasRendered') ) ) {
            window.facesImageCompanion.afterRender();
        }
        
        if( step === 'fbobjects' && (! window.fbObjImageCompanion.model.get('hasRendered') ) ) {
            window.fbObjImageCompanion.afterRender();
        }

        if( step === 'intro' ) {
            $('#intro-header').fadeIn();    
            $('.campaign-name').addClass('hide');
        } else {
            $('#intro-header').fadeOut();    
            $('.campaign-name').removeClass('hide');
        }

        if( $(this).attr('id') === 'step1-next' ) {
            $('.campaign-name span').text( $('#id_name').val() );
        }
       
        $('body,html').scrollTop( 0 );
    } );

    carouselEl.carousel( { interval: 20000, pause: "" } );

    $('#campaign-name-modal').on( 'hide', function() {
        carouselEl.carousel('cycle');
    } );

    var showNameModal = function() {
        carouselEl.carousel('pause');
        $('#campaign-name-modal').modal();
        $('#campaign-name-modal').on( 'shown', function() { 
            $('#id_name').focus() } );
    }

    $('.get-started-btn').on( 'click', showNameModal );
    carouselEl.on( 'click', 'img', showNameModal );

    $('#step1-next').on( 'click', function() {
        $('#campaign-name-modal').modal('hide');
    } );
    
    $('#step2-prev').on( 'click', function() {
        carouselEl.carousel('cycle');
    } );

    $( document ).on( 'keydown', function(e) {
        var nameSubmitButton;
        
        if( e.keyCode === 13 ) {
            nameSubmitButton = $('#step1-next');

            if( nameSubmitButton.is(':visible') ) {
                //prevent <button>[0] from being clicked
                e.preventDefault();
                nameSubmitButton.click();
                $('body,html').scrollTop( 0 );
            }
        }
    } );

    if( $('#id_name').val() ) { $('.get-started-btn').click(); }
} );
</script>
{% endblock %}
