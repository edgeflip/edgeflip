<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US"
      xmlns:fb="https://www.facebook.com/2008/fbml"> 
	<head prefix="og: http://ogp.me/ns# edgeflip: 
                  http://ogp.me/ns/apps/edgeflip#">
	<title>TIME Targeted Sharing Article</title>
	<meta property="fb:app_id" content="471727162864364" /> 
	<meta property="og:type" content="edgeflip:article" /> 
	<meta property="og:title" content="TIME Targeted Sharing Article" /> 
	<meta property="og:image" content="{{ url_for('static', filename='doc_brown.jpg') }}" /> 
	<meta property="og:description" content="According to TIME Magazine, Targeted Sharing is cool! Jim Messina called it one of the best things Obama's re-election campaign did and now you can use it to, for the low price of $100 Million." /> 
	<meta property="og:url" content="http://rayid.bigmarker.com/button">

	<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.4/dojox/html/resources/ellipsis.css" />

	<STYLE>

		.friends_table {
			border: 5px solid #e4e6e0;
			background-color: #e4e6e0;
		}

		.friend_box {
			padding: 6px;
			border: thin solid gray;
			border-radius: 10px;
			-moz-border-radius: 10px;
			background-color: #07304e;
			width: 172px;
			position: relative;
		}

		.friend_pic {
			width: 60px;
			text-align: center;
			vertical-align: middle;
			display: inline-block;
		}

		.friend_txt {
			width: 100px;
			text-align: left;
			vertical-align: top;
			display: inline-block;
		}

		.friend_name {
			color: white;
			text-decoration: none;
			width: 100%; 
			overflow: hidden; 
			white-space: nowrap; 
			text-overflow: ellipsis;
			-o-text-overflow: ellipsis;
			-webkit-text-overflow: ellipsis;
		}

		.friend_checkbox {
			width: 100px;
			text-align: right;
		}

		.dojoxEllipsis,
		.dojoxEllipsisShown {
			color: white;
		}

		.xout {
			background-color: #CC0000; 
			color: white; 
			width: 12px; 
			height: 12px; 
			border: thin solid maroon; 
			border-radius: 6px; 
			font-size: 10px; 
			font-weight: bold; 
			text-align: center; 
			vertical-align: middle; 
			font-family: arial,sans-serif; 
			cursor: pointer;
			position: absolute;
			top: -3px;
			left: -3px;
			z-index: 10;
		}

	    .msg_friend_name {
	      color: #0A5195;
	      border-bottom: thin dashed #0A5195;
	    }

	    .msg_picker,
	    .msg_title {
	    	width: 600px;
	    	margin: 0px auto; 
	    	display: table;
	    }

	    .msg_title {
	    	font-size: 22px;
	    	text-align: left;
	    	color: #07304e;
	    	padding-left: 15px;
	    }

	    .msg_picker {
	    	border: 1px solid #07304e;
	    	border-radius: 20px;
	    	background-color: #E6F2FF;
	    	padding: 10px;
	    }

	    #other_msg {
	    	display: none;
	    	border: solid thin gray;
	    	background-color: white;
	    	padding: 10px;
	    	width: 500px;
	    }

	    #do_share_button {
	    	background-image: url('{{ url_for('static', filename='share.jpg') }}'); 
	    	width: 255px; 
	    	height: 40px; 
	    	color: white; 
	    	cursor: pointer; 
	    	display: block;
	    }

		#manual_add,
	    .ui-autocomplete,
	    .ui-menu, .ui-menu-item {
	    	font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
			font-size: 62.5%;
	    }

	    #manual_add {
	    	padding-top: 5px;
	    }

	    .ui-autocomplete {
		    max-height: 100px;
		    overflow-y: auto;
		    /* prevent horizontal scrollbar */
		    overflow-x: hidden;
		}
		/* IE 6 doesn't support max-height
		 * we use height instead, but this forces the menu to always be this tall
		 */
		* html .ui-autocomplete {
			height: 100px;
		}

		.added_friend {
			font-size: smaller;
		    color: white;
		    border: thin solid white;
		    border-radius: 5px;
		    padding: 2px;
		    margin: 2px;
		    background-color: #003F77;
		    display: inline-block;
		}

		.added_x {
		    border-left: thin solid white;
		    margin-left: 3px;
		    padding-left: 2px;
		    padding-right: 1px;
		    display:inline-block;
		    cursor: pointer;
		    font-weight: bold;
		}

	</STYLE>


  	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />

	<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
	<script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dojo/dojo.xd.js"></script>
	<script>
		dojo.require("dojox.html.ellipsis");
	</script>

	<SCRIPT type="text/javascript">

		var myfbid; // The FB ID of the current user to be filled in upon auth.

		function preload(arrayOfImages) {
    		$(arrayOfImages).each(function () {
        		$('<img />').attr('src',this);
        		// .load(function() {alert('Preloaded: '+this)} );
        		// .appendTo('body').css('display','none');
    		});
		}
		
		function button_change(div_id, img_name) {
			document.getElementById(div_id).style.backgroundImage="url('"+img_name+"')";
		}

		function show_friends() {
			hn = window.innerHeight*0.35;
			$("#share_content").animate({height:hn}, 500);

			setTimeout(function(){document.getElementById('share_button').style.display='none'; document.getElementById('friends_div').style.display='block';}, 400);

			// FB login stuff??
			FB.login(function(response) {
				if (response.authResponse) {
					FB.api('/me', function(info) {
						login(response, info);
					});	   
				}
			}, {scope:'email,user_birthday,status_update,publish_stream,user_about_me'});

		}

	</SCRIPT>

	<SCRIPT>
		imgsToLoad = [	"{{ url_for('static', filename='button_mouse.jpg') }}", 
						"{{ url_for('static', filename='share.jpg') }}",
						"{{ url_for('static', filename='share_mouse.jpg') }}",
						"{{url_for('static', filename='aniprogress.gif')}}"
					];
		preload(imgsToLoad);
	</SCRIPT>

	<SCRIPT>

	$(document).on( 'mouseenter', '.xout', function(e) { $(this).css('background-color', 'red'); });
	$(document).on( 'mouseleave', '.xout', function(e) { $(this).css('background-color', '#CC0000'); });

	function doReplace(old_fbid) {

		var div_id = '#friend-'+old_fbid;

		// Remove the friend from the messages
		var idx = recips.indexOf(old_fbid);
		if (idx > -1) { recips.splice(idx, 1); }
		$('#msg-txt-friend-'+old_fbid).remove();

		if (nextidx < friends.length) {
			// Figure out the new friend
			var friend = friends[nextidx];
			var id = friend['id'];
			var fname = friend['fname'];
			var lname = friend['lname'];

			// Add the new friend to the list of message tags (since they'll start off pre-checked)
			recips.push(id);
			$('#other_msg').append(' <span class="msg_friend_name msg-txt-friend" id="msg-txt-friend-'+id+'" contentEditable="False">'+fbnames[id]+'</span> ');

			// Update the friends shown
			// $(div_id).replaceWith(friendHTML(old_fbid, id, fname, lname, div_id));
			friendHTML(old_fbid, id, fname, lname, div_id);

			nextidx++;
		} else {
			// No new friends to add, so just hide this one
			$(div_id).remove();
		}

		// Update the message text with the new names
		$('.preset_names').html(friendNames());
	}

	function friendHTML(oldid, id, fname, lname, div_id) {

		var new_html;
		var userid = myfbid; // myfbid should get set globablly upon login/auth
		var appid = 471727162864364;
		var content = 'edgeflip:article http://rayid.bigmarker.com/button';

		var params = JSON.stringify({
			userid: userid,
			appid: appid,
			content: content,
			oldid: oldid,
			newid: id,
			fname: fname,
			lname: lname
		});

		$.ajax({
			type: "POST",
			url: '/suppress',
			contentType: "application/json",
			dataType: 'html',
			data: params,
			error: function(jqXHR, textStatus, errorThrown) {
						new_html = 'Error pants: ' + textStatus + ' ' + errorThrown;
						$(div_id).replaceWith(new_html);
			},
			success: function(data) {
						new_html = data;
						$(div_id).replaceWith(new_html);
			}
		});

	}

	</SCRIPT>


  <script type="text/javascript">

  function doShare()
  {

    if (recips.length == 0) { alert('Please choose at least one friend to share with.'); return; }


    msg_recips = "";

    for (i=0; i < (recips.length-1); i++) {
      msg_recips += "@[" + recips[i] + "], ";
    }

    if (recips.length > 2) {
      msg_recips += 'and ' + "@[" + recips[recips.length-1] + "]";
    } else if (recips.length == 2) {
      msg_recips = "@[" + recips[0] + "] and @[" + recips[1] + "]";
    } else {
      msg_recips = "@[" + recips[0] + "]";
    }


  	var msg_type = $('input:radio[name=msg]:checked').val();
  	var msg = "";

    if (!msg_type || msg_type === "") { alert('Please choose a message to send or write your own'); return;}

  	if (msg_type === "hi-there") {
  		msg = 'Hi there '+msg_recips+' -- I just donated to Chicago Public Radio and you should, too!';
  	} else if (msg_type === "kasell") {
  		msg = 'Carl Kasell has a message for you. Go donate to Chicago Public Radio, '+msg_recips+'!';
  	} else if (msg_type === "other") {

      for (i=0; i < recips.length; i++) {
        $('#msg-txt-friend-'+recips[i]).replaceWith("@[" + recips[i] + "]");
      }
      msg = $('#other_msg').html();
  	} else {
  		alert("Ruh-Roh!!");
  	}


    FB.api(
      '/me/edgeflip:read',
      'post',
      { 
      	contribution: 'http://rayid.bigmarker.com/button',
      	message: msg
      },
      function(response) {
         if (!response || response.error) {
            alert('Error occured ' + response.error.message);
         } else {
            alert('Post was successful! Action ID: ' + response.id);
         }
      });
  }
  </script>

  <script>

    var recips = [];

    function friendNames() {
      recip_str = "";

      if (recips.length == 0) { return ""; }

      for (i=0; i < (recips.length-1); i++) {
        recip_str += "<span class='msg_friend_name'>" + fbnames[recips[i]] + "</span>, ";
      }

      if (recips.length > 2) {
        recip_str += 'and ' + "<span class='msg_friend_name'>" + fbnames[recips[recips.length-1]] + "</span>";
      } else if (recips.length == 2) {
        recip_str = "<span class='msg_friend_name'>" + fbnames[recips[0]] + "</span> and <span class='msg_friend_name'>" + fbnames[recips[1]] + "</span>";
      } else {
        recip_str = "<span class='msg_friend_name'>" + fbnames[recips[0]] + "</span>";
      }

      return recip_str;
    }

    function toggleFriend(fbid) {
      var idx = recips.indexOf(fbid);
      if (idx > -1) { recips.splice(idx, 1); }
      $('#msg-txt-friend-'+fbid).remove();

      if ($('#box-'+fbid).is(':checked')) {
        recips.push(fbid);
        $('#other_msg').append(' <span class="msg_friend_name msg-txt-friend" id="msg-txt-friend-'+fbid+'" contentEditable="False">'+fbnames[fbid]+'</span> ');
      }

      $('.preset_names').html(friendNames());

    }

  	function updateMsg() {

  	  var msg_type = $('input:radio[name=msg]:checked').val();
      if (msg_type === "other") { 
        $('#other_msg').show().focus();

        var reptxt = $('#other_msg').text().indexOf('Replace this text with your message for ');

        if ( reptxt > -1 ) {

          var txtnode = document.getElementById('other_msg');

          if (document.createRange) {

            var selection = window.getSelection();
            var range = document.createRange();

            range.setStart(txtnode.firstChild, reptxt);
            range.setEnd(txtnode.firstChild, reptxt+40);
            selection.removeAllRanges();
            selection.addRange(range);

          } else {

            var range = document.body.createTextRange();
            range.moveToElementText($('#other_msg'));
            range.moveStart("character", reptxt);
            range.collapse(true);
            range.moveEnd("character", reptxt+40);
            range.select();

          }
        }
      } else {
        $('#other_msg').hide();
      }

  	}

  </script>


</HEAD>

<BODY bgcolor="#ffffff">
<!-- http://swampland.time.com/2012/11/07/inside-the-secret-world-of-quants-and-data-crunchers-who-helped-obama-win/ -->
<!-- http://swampland.time.com/2012/11/20/friended-how-the-obama-campaign-connected-with-young-voters/ -->
<iframe src="http://swampland.time.com/2012/11/20/friended-how-the-obama-campaign-connected-with-young-voters/print/" id="share_content" width="100%" height="85%" border=0></iframe>
<BR><BR>
<CENTER>

<!-- SHARE BUTTON -->
<div id="share_button" style="background-image:url('{{ url_for('static', filename='button.jpg') }}'); width:255px; height:40px; color:white; cursor:pointer;" onmouseover="button_change('share_button', '{{ url_for('static', filename='button_mouse.jpg') }}');" onmouseout="button_change('share_button', '{{ url_for('static', filename='button.jpg') }}');" onclick="show_friends();"></div>

<div id="friends_div" style="display:none;">

	<div id='progress' style='text-align: center; display: none'>
		<img src="{{url_for('static', filename='aniprogress.gif')}}"><p>
	</div>
	
	<div id="your-friends-here"></div>

</div>

</CENTER>


<div id="fb-root"></div>
<script type="text/javascript">
	
	window.fbAsyncInit = function() {


		FB.init({ appId: '471727162864364', //change the appId to your appId
			status: true, 
			cookie: true,
			xfbml: true,
			oauth: true});

	}; // fbAsyncInit

	(function() {
		var e = document.createElement('script'); e.async = true;
		e.src = document.location.protocol 
			+ '//connect.facebook.net/en_US/all.js';
		document.getElementById('fb-root').appendChild(e);
	}());
	
	
	function login(response, info){
		if (response.authResponse) {
			var accessToken	= response.authResponse.accessToken;
			var fbid = info.id;
			var num = 1000;
			myfbid = fbid;

			var friends_div = $('#your-friends-here');
			var progress = $('#progress');


			progress.show();	
						
			var params = JSON.stringify({
				fbid: fbid,
				token: accessToken,
				num: num
			});

			$.ajax({
				type: "POST",
				url: '/edgeflip_faces',
				contentType: "application/json",
				dataType: 'html',
				data: params,
				error: function(jqXHR, textStatus, errorThrown) {
							friends_div.text('Error pants: ' + textStatus + ' ' + errorThrown);
							progress.css('display', 'none');
				},
				success: function(data) {
							friends_div.html(data);	
							friends_div.show();
							progress.css('display', 'none');
							$('#do_share_button').show()
				}
			});

		}
	}
	
</script>

</BODY>
</HTML>