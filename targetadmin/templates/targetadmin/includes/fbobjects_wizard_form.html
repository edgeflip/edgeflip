<div class="row">
    <div class="span12">
        <div class="row targeting-header">
            <div class="fb-obj-info-item">
                <h4>Facebook Post</h4>
                <p>
                    Below to the right, you see an example of a Facebook post generated by a campaign.  This is the what your supporters will share on Facebook.
                    Let's customize your post now.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="span5" id="fb-obj-input-wrapper">
        <div id="fb-obj-input-popover"></div>

        <div class="fb-obj-item">
            <label for="{{ fb_obj_form.org_name.id_for_label }}">{{ fb_obj_form.org_name.label}}:</label>
            <div>{{ fb_obj_form.org_name }}</div>
        </div>

        <div class="suggested-message-container">
            <h4>Suggested Messages</h4>
            <p>
                Fill out the following fields to provide your supporters with a suggested message to be shown on their post.
            </p>
            <p>
                They can enable this feature by clicking the "Suggest A Message" button on the faces page.
            </p>
            <div class="fb-obj-group">
                <h5><span>Message 1</span></h5>
                <div class="fb-obj-item">
                    <label for="{{ fb_obj_form.msg1_pre.id_for_label }}">{{ fb_obj_form.msg1_pre.label}}:</label>
                    <div>{{ fb_obj_form.msg1_pre }}</div>
                </div>

                <div class="fb-obj-item">
                    <label for="{{ fb_obj_form.msg1_post.id_for_label }}">{{ fb_obj_form.msg1_post.label}}:</label>
                    <div>{{ fb_obj_form.msg1_post }}</div>
                </div>
            </div>

            <div class="fb-obj-group">
                <h5><span>Message 2</span></h5>
                <div class="fb-obj-item">
                    <label for="{{ fb_obj_form.msg2_pre.id_for_label }}">{{ fb_obj_form.msg2_pre.label}}:</label>
                    <div>{{ fb_obj_form.msg2_pre }}</div>
                </div>

                <div class="fb-obj-item">
                    <label for="{{ fb_obj_form.msg2_post.id_for_label }}">{{ fb_obj_form.msg2_post.label}}:</label>
                    <div>{{ fb_obj_form.msg2_post }}</div>
                </div>
            </div>
        </div>

        <div class="fb-obj-item">
            <label for="{{ fb_obj_form.og_title.id_for_label }}">{{ fb_obj_form.og_title.label}}:</label>
            <div>{{ fb_obj_form.og_title }}</div>
        </div>

        <div class="fb-obj-item">
            <label for="{{ fb_obj_form.og_image.id_for_label }}">{{ fb_obj_form.og_image.label}}:</label>
            <div>{{ fb_obj_form.og_image }}</div>
        </div>
        
        <div class="fb-obj-item">
            <label for="{{ fb_obj_form.og_description.id_for_label }}">{{ fb_obj_form.og_description.label }}:</label>
            <div>{{ fb_obj_form.og_description}}</div>
        </div>

        <div class="fb-obj-item">
            <label for="{{ campaign_form.content_url.id_for_label }}">{{ campaign_form.content_url.label }}:</label>
            <div>{{ campaign_form.content_url }}</div>
        </div>
    </div>

    <div id="fb-obj-img-container" class="span7 img-helper-wrapper">
        <div id="fb-obj-popover"></div>
        <img id="fb-obj-img" class="img-helper" src="{{ STATIC_URL }}img/fb-obj-example.png">
    </div>
</div>
<div class="row wizard-button-container">
    <input type="submit" class="btn btn-large btn-primary step-submit fbobject-step" value="Submit" id="wizard-submit">
    <a href="#" id="step3-prev" class="btn btn-large btn-danger step-submit" data-step="faces">Previous</a>
</div>


<script>

    // call on document ready
    $( function() {

        //constructor
        var fbObjIndicator = function() {

            //add properties to our instance
            $.extend( this, {

                //store $ stuff
                window: $(window),
                html: $('html'),
                body: $('body'),
                imageContainer: $('#fb-obj-img-container'),
                imagePopoverEl: $('#fb-obj-popover'),
                inputPopoverEl: $('#fb-obj-input-popover'),
                inputWrapper: $('#fb-obj-input-wrapper'),

                //store calculations
                imageContainerOffset: { top: undefined, left: undefined },
                inputWrapperHeight: 0,
                imageContainerHeight: undefined,

                //store "models"
                isInitialized: false,
                currentFormField: undefined,
                verticalImagePadding: 10,


                imageMetaData: {
                    el: $('#fb-obj-img'),
                    originalDims: { x: 960, y: 1076 },
                    multiplier: { x: undefined, y: undefined },
                    currentDims: { x: undefined, y: undefined }
                }

            } );


            //add more properties, these rely on things extended above
            //this is why another extend is called
            $.extend( this, {
              
                //data about form fields and their relation to images 
                //TODO: should be passed into constructor for reuse 
                formFields: {

                    org_name: {
                        el: $('input[name="org_name"]'),
                        coords: { x: 540, y: 80 },
                        placement: 'bottom',
                        text: "The cause or organization you enter will replace 'Freakonomics Radio' here.",
                        title: ''
                    },

                    msg1_pre: {
                        el: $('input[name="msg1_pre"]'),
                        coords: { x: 56, y: 206 },
                        placement: 'bottom',
                        text: "Text to be displayed before friend names.",
                        title: ''
                    },
                    
                    msg1_post: {
                        el: $('input[name="msg1_post"]'),
                        coords: { x: 519, y: 204 },
                        placement: 'bottom',
                        text: "Text that will go after the friend names.",
                        title: ''
                    },

                    msg2_pre: {
                        el: $('input[name="msg2_pre"]'),
                        coords: { x: 56, y: 206 },
                        placement: 'bottom',
                        text: "Alternate text to suggest before friend names so that your user's feeds don't all look the same.",
                        title: ''
                    },
                    
                    msg2_post: {
                        el: $('input[name="msg2_post"]'),
                        coords: { x: 519, y: 204 },
                        placement: 'bottom',
                        text: "Alternate text for after the friend names.  If specified, we will randomly pick a suggestion.",
                        title: ''
                    },

                    og_title: {
                        el: $('input[name="og_title"]'),
                        coords: { x: 735, y: 729 },
                        placement: 'right',
                        text: "Your title will go here.",
                        title: ''
                    },
                    
                    og_image: {
                        el: $('input[name="og_image"]'),
                        coords: { x: 678, y: 429 },
                        placement: 'right',
                        text: "Your image will go here.",
                        title: ''
                    },
                    
                    og_description: {
                        el: $('textarea[name="og_description"]'),
                        coords: { x: 898, y: 800 },
                        placement: 'right',
                        text: "Your description will go here.",
                        title: ''
                    },

                    content_url: {
                        el: $('input[name="content_url"]'),
                        text: "When someone clicks on the post, this is where we will send them.",
                        title: ''
                    }
                }
                
            } );
                
            return this;
        }

        //add methods to our object
        $.extend( fbObjIndicator.prototype, {

            init: function() {
                this.storeElementDimensions();
                this.imageContainer.height( this.windowHeight - this.imageContainerOffset.top - 10 );
                $('body,html').scrollTop( 0 );
                this.maxScroll = this.body.height() - this.windowHeight;
                this.sizeAndPositionImage();
                this.initPopovers();
                this.delegateEvents();
                this.isInitialized = true;
            },

            initPopovers: function() {
                var self = this;

                //instantiate img popover
                this.imagePopoverEl.popover( {
                    animation: false,
                    trigger: 'manual',
                    title: function() { return self.getPopoverTitle(); },
                    content: function() { return self.getPopoverText(); },
                    placement: function() { return self.getPopoverPlacement(); }
                } );

                //instantiate img popover
                this.inputPopoverEl.popover( {
                    animation: false,
                    trigger: 'manual',
                    content: function() { return self.getPopoverText(); },
                    placement: 'right'
                } );
            },

            delegateEvents: function() {
                var self = this;

                //binds form focus / blur events
                $.each( this.formFields, function( fieldName, formMetaData ) {

                    formMetaData.el.on( 'focus', function() {
                                     self.setCurrentFormField( fieldName )
                                         .scrollToField() } )

                            .on( 'blur', function() {
                                    self.setCurrentFormField( null )
                                        .hidePopover() } );
                } );

                //handle window resize so our popovers and images look alright
                this.window.resize( function() { self.handleWindowResize(); } );
                this.window.scroll( _.debounce( function() { self.handleWindowScroll() }, 150 ) );

            },

            setCurrentFormField: function( fieldName ) { this.currentFormField = fieldName; return this; },

            positionAndShowPopover: function() {
 
                var focusedFormMetaData = this.formFields[ this.currentFormField ];
            
                if( focusedFormMetaData.coords ) {
                    this.inputPopoverEl.popover('hide');
                    this.imagePopoverEl.css( {
                        top: ( focusedFormMetaData.coords.y * this.imageMetaData.multiplier.y ),
                        left: ( focusedFormMetaData.coords.x * this.imageMetaData.multiplier.x ) } ).popover('show');
                } else {
                    this.imagePopoverEl.popover('hide');
                    this.inputPopoverEl.css( {
                        top: focusedFormMetaData.el.offset().top + ( focusedFormMetaData.el.outerHeight( true ) / 2 ),
                        left: focusedFormMetaData.el.offset().left + focusedFormMetaData.el.outerWidth( true ) + 5 } ).popover('show');
                }

                return this;    
            },

            hidePopover: function() { this.imagePopoverEl.popover('hide'); return this; },

            getPopoverText: function() { return this.formFields[ this.currentFormField ].text; },
            
            getPopoverTitle: function() { return this.formFields[ this.currentFormField ].title; },

            getPopoverPlacement: function() { return this.formFields[ this.currentFormField ].placement; },

            scrollToField: function() {

                var difference,
                    maxDifference = this.inputWrapperHeight - this.imageContainerHeight,
                    formElTop = this.formFields[ this.currentFormField ].el.offset().top,
                    self = this,
                    scrollTop = ( formElTop - ( this.window.height() / 2 ) );

                difference =
                    ( formElTop ) -
                    ( ( this.imageContainerOffset.top - parseFloat( this.imageContainer.css('top' ) ) ) + ( this.imageMetaData.currentDims.y / 2 ) );

                if( difference < 0 ) { difference = 0; }
                else if( difference > maxDifference ) { difference = maxDifference; }

                this.imageContainer.animate(
                    { 'top': difference },
                    { complete: function() {
                        self.imageContainerOffset = self.imageContainer.offset(); } } );

                if( ( this.scrollTop >= this.maxScroll && scrollTop >= this.maxScroll ) ||
                    ( this.scrollTop === 0 && scrollTop <= 0 ) ) {
                    self.positionAndShowPopover();
                } else {
                    $('body,html').animate( { 'scrollTop' : scrollTop } );
                }

                return this;
            },

            handleWindowScroll: function() {

                this.scrollTop = ( this.body.scrollTop() != 0 )
                    ? this.body.scrollTop()
                    : this.html.scrollTop();

                this.sizeAndPositionImage();
            },

            sizeAndPositionImage: function() {

                var diff = this.inputWrapperOffset.top - this.scrollTop,
                    top = 0,
                    stickyHeaderBump = 0,
                    self = this;

                //if the viewport contains the top of the input wrapper
                if( diff > 0 ) {

                    if( diff < 60 ) {
                        stickyHeaderBump = 60 - diff;
                    } 
                    this.imageContainerHeight = this.windowHeight - diff - this.verticalImagePadding - stickyHeaderBump;
                    top = stickyHeaderBump;

                //if the viewport contains only our form fields and our image
                } else if( ( this.scrollTop + this.windowHeight ) <
                           ( this.inputWrapperHeight + this.inputWrapperOffset.top ) ) {

                    this.imageContainerHeight = this.windowHeight -
                        this.navbarHeight -
                        ( this.verticalImagePadding * 2 );

                    top = ( this.scrollTop - this.inputWrapperOffset.top ) +
                          this.navbarHeight + this.verticalImagePadding;
                
                //if the viewport contains the bottom of the input wrapper
                } else {

                    this.imageContainerHeight = 
                        ( this.inputWrapperHeight + this.inputWrapperOffset.top - this.scrollTop ) -
                        ( this.navbarHeight + this.verticalImagePadding );

                    top = this.scrollTop - this.inputWrapperOffset.top +
                          this.navbarHeight + this.verticalImagePadding;
                }

                this.imageContainer.animate(
                    { top: top, height: this.imageContainerHeight },
                    { duration: 200,
                      complete: function() {
                        self.setImageMetaData();
                        if( self.currentFormField ) { self.positionAndShowPopover(); }
                      } } );
        
                return;
                this.imageContainer.css( 'top', top );
                this.imageContainer.height( this.imageContainerHeight );
                self.setImageMetaData();
                if( self.currentFormField ) { self.positionAndShowPopover(); }
            },

            handleWindowResize: function() {

                this.windowHeight = this.window.height();
                this.sizeAndPositionImage();
            },

            storeElementDimensions: function() {
                this.imageContainerOffset = this.imageContainer.offset();
                this.inputWrapperOffset = this.inputWrapper.offset();
                this.inputWrapperHeight = this.inputWrapper.outerHeight( true );
                this.windowHeight = this.window.height();
                this.navbarHeight = $('.navbar').outerHeight( true );
            },


            setImageMetaData: function() {

                this.imageMetaData.currentDims = {
                    x: this.imageMetaData.el.outerWidth(true),
                    y: this.imageMetaData.el.outerHeight(true)
                };    

                this.imageMetaData.multiplier = {
                    x: this.imageMetaData.currentDims.x / this.imageMetaData.originalDims.x,
                    y: this.imageMetaData.currentDims.y / this.imageMetaData.originalDims.y
                }
            }

        } );

        window.fbObjIndicator = new fbObjIndicator();

    } );

</script>
