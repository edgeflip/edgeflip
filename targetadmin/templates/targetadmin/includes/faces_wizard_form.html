<div class="row">
    <div class="span12">
        <div class="row targeting-header">
            <div class="filter-info-item">
                <h4>Create your Faces Page</h4>
                <p>
                    Below to the right, you see an example of our faces page.  This is the interface your supporters will use to share with their friends.
                    Let's customize your page now.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span5" id="input-wrapper">

        <div class="fb-obj-group">
            <div class="fb-obj-item">
                <label for="{{ fb_obj_form.sharing_prompt.id_for_label }}">{{ fb_obj_form.sharing_prompt.label}}:</label>
                <div>{{ fb_obj_form.sharing_prompt}}</div>
            </div>
            <div class="fb-obj-item">
                <label for="{{ fb_obj_form.sharing_sub_header.id_for_label }}">{{ fb_obj_form.sharing_sub_header.label }}:</label>
                <div>{{ fb_obj_form.sharing_sub_header }}</div>
            </div>
        </div>
    </div>

    <div id="img-helper-container" class="span7 img-helper-wrapper">
        <div id="faces-img-popover"></div>
        <img id="faces-img" class="img-helper" src="{{ STATIC_URL }}img/faces-example.png">
    </div>
</div>
<div class="row wizard-button-container">
    <a href="#" id="step3-next" class="btn btn-large btn-primary step-submit filter-step" data-step="fbobjects">Next</a>
    <a href="#" id="step3-prev" class="btn btn-large btn-danger step-submit filter-step" data-step="filtering">Previous</a>
</div>
<script>

    // call on document ready
    $( function() {

        //constructor
        var facesIndicator = function() {
            var self = this;

            //add properties to our instance
            $.extend( this, {

                //store $ stuff
                myWindow: $(window),
                imageContainer: $('#img-helper-container'),
                popoverEl: $('#faces-img-popover'),
                inputWrapper: $('#input-wrapper'),

                //store calculations
                imageContainerOffset: { top: undefined, left: undefined },
                inputWrapperHeight: 0,
                imageContainerHeight: undefined,

                //store "models"
                isInitialize: false,
                currentFormField: undefined,


                //TODO: should be passed into constructor for reuse
                imageMetaData: {
                    el: $('#faces-img'),
                    originalDims: { x: 739, y: 519 },
                    multiplier: { x: undefined, y: undefined },
                    currentDims: { x: undefined, y: undefined }
                }
            } );


            //add more properties, these rely on things extended above
            //this is why another extend is called
            $.extend( this, {
              
                //data about form fields and their relation to images 
                //TODO: should be passed into constructor for reuse 
                formFields: {

                    //coords:y: should be 90, but I have reason to believe
                    // bootstrap is doing something weird here
                    //when I change the placement to anything other than right
                    //the popover points in the correct spot
                    sharing_prompt: {
                        el: $('input[name="sharing_prompt"]'),
                        coords: { x: 647, y: 65 },
                        placement: 'right',
                        text: "Your headline will go here."
                    },

                    //coords:y: should be 170, see above
                    sharing_sub_header: {
                        el: $('input[name="sharing_sub_header"]'),
                        coords: { x: 612, y: 150 },
                        placement: 'right',
                        text: "Your sub header will go here."
                    }
                }
            } );

            //instantiate boostrap popover
            this.popoverEl.popover( {
                animation: false,
                trigger: 'manual',
                content: function() { return self.getPopoverText(); },
                placement: function() { return self.getPopoverPlacement(); }
            } );

            //binds form focus / blur events
            $.each( this.formFields, function( fieldName, formMetaData ) {

                formMetaData.el.on( 'focus', function() {
                                 self.setCurrentFormField( fieldName )
                                     .handleFormFocus() } )

                        .on( 'blur', function() {
                                self.setCurrentFormField( null )
                                    .hidePopover() } );
            } );

            //handle window resize so our popovers and images look alright
            //TODO: add debouncer
            this.myWindow.resize( function() { self.handleWindowResize(); } );

            return this;
        }

        //add methods to our object
        $.extend( facesIndicator.prototype, {

            init: function() {
                this.setImageContainerOffset();
                this.setImageContainerSize();
                this.setImageMetaData();
                this.isInitialized = true;
            },

            setCurrentFormField: function( fieldName ) { this.currentFormField = fieldName; return this; },

            positionAndShowPopover: function() {
 
                var focusedFormMetaData = this.formFields[ this.currentFormField ];
               
                this.popoverEl
                    .css( {
                        top: ( focusedFormMetaData.coords.y * this.imageMetaData.multiplier.y ),
                        left: ( focusedFormMetaData.coords.x * this.imageMetaData.multiplier.x ) } ).popover('show');

                return this;    
            },

            hidePopover: function() { this.popoverEl.popover('hide'); return this; },

            getPopoverText: function() { return this.formFields[ this.currentFormField ].text; },

            getPopoverPlacement: function() { return this.formFields[ this.currentFormField ].placement; },

            handleFormFocus: function() {

                this.setImageMetaData();
                this.updateImagePosition();
                this.positionAndShowPopover();

                return this;
            },

            updateImagePosition: function() {

                var difference,
                    maxDifference = this.inputWrapperHeight - this.imageContainerHeight,
                    formElTop = this.formFields[ this.currentFormField ].el.offset().top,
                    self = this;

                this.inputWrapperHeight = this.inputWrapper.height();

                difference =
                    ( formElTop ) -
                    ( ( this.imageContainerOffset.top - parseFloat( this.imageContainer.css('top' ) ) ) + ( this.imageMetaData.currentDims.y / 2 ) );

                if( difference < 0 ) { difference = 0; }
                else if( difference > maxDifference ) { difference = maxDifference; }

                this.imageContainer.animate(
                    { 'top': difference },
                    { complete: function() { self.setImageContainerOffset(); } } );

                $('body,html').animate( { 'scrollTop' : ( formElTop - ( this.myWindow.height() / 2 ) ) } );

                return this;
            },

            setImageContainerSize: function() {
               
                if( this.imageContainer.is(':visible') ) {

                    //TODO: 30 should be obj property
                    this.imageContainerHeight =
                        this.myWindow.height() -
                        ( this.imageContainerOffset.top - parseFloat( this.imageContainer.css('top') ) ) -
                        30;

                    this.imageContainer.height( this.imageContainerHeight );
                }
            },

            handleWindowResize: function() {

                this.setImageContainerSize();
                this.setImageMetaData();
                
                if( this.currentFormField ) { this.positionAndShowPopover(); }
            },

            setImageContainerOffset: function() {
                this.imageContainerOffset = this.imageContainer.offset();
            },

            setImageMetaData: function() {

                this.inputWrapperHeight = this.inputWrapper.height();

                this.imageMetaData.currentDims = {
                    x: this.imageMetaData.el.width(),
                    y: this.imageMetaData.el.height()
                };    

                this.imageMetaData.multiplier = {
                    x: this.imageMetaData.currentDims.x / this.imageMetaData.originalDims.x,
                    y: this.imageMetaData.currentDims.y / this.imageMetaData.originalDims.y
                }
            }

        } );

        window.facesIndicator = new facesIndicator();

    } );

</script>
